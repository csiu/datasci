<!DOCTYPE html>
<html>
<style>
body {
    font: 12px sans-serif;
}
.axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}
.ylab {
    fill: #A9A9A9;
}
text.xticklab {
	fill: #000;
}
label {
	position: absolute;
	top: 11.5px;
	left: 40px;
	color: #A9A9A9;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<body>

<label><input type="checkbox"> Sort by levels</label>
<div class="chart"></div>

<script>
var margin = {top: 20, right: 55, bottom: 100, left: 30},
    width = 666 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

var color = d3.scale.category20c();

var x = d3.scale.ordinal()
	.rangeRoundBands([0, width], 0.1);

var y = d3.scale.linear()
	.range([height,0])
	.domain([0,250]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var chart = d3.select('.chart')
  .append('svg')
	.attr('width', width + margin.left + margin.right)
	.attr('height', height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.tsv("https://raw.githubusercontent.com/csiu/datasets/master/mstory.tsv", type, function(error, data){
	var originalorder = data.map(function(d){ return d['Job']; });

    x.domain(originalorder);
	color.domain(originalorder);

	var bar = chart.selectAll("g")
    	.data(data)
	  .enter().append("g")
	  	.attr("class", "gbar")
	    .attr("transform", function(d, i) { return "translate(" + x(d['Job']) + ",0)"; });

	bar.append("rect")
	  	.attr("class", function(d){ return d.Job.replace(/ /g, ""); })
	    .attr("y", function(d){return y(d.Level); })
	    .attr("height", function(d) { return (y(0) - y(d.Level)); })
	    .attr("width", x.rangeBand())
	    .style("fill", function(d){ return color(d.Job); });

	bar.append("text")
		.attr("class", "xticklab")
	  	.attr("transform", "rotate(-90)")
	  	.attr("dx", function(d){ return -y(d.Level)-2; })
	  	.attr("dy", ".8em")
	  	.style("text-anchor", "end")
	    .text(function(d) { return d.Job; });

	chart.append("g")
	    .attr("class", "y axis")
	    .call(yAxis)
	.append("text")
		.attr("class", "ylab")
	    .style("text-anchor", "end")
	    .attr("dy", "-.3em")
	    .text("Level");

    d3.select("input")
    	.on("change", change);

	var sortTimeout = setTimeout(function() {
	    d3.select("input").property("checked", true).each(change);
	  }, 2000);

	function change() {
		clearTimeout(sortTimeout); //Not working?

	    // Copy-on-write since tweens are evaluated after a delay.
	    var x0 = x.domain(data.sort(this.checked
	    		? function(a, b) { return b.Level - a.Level; }
		        : function(a, b) { return 0; }) //Not used
		        .map(function(d) { return d.Job; }))
	        .copy();
	    if (!this.checked) {
	    	x0.domain(originalorder);
	    }

	    chart.selectAll(".gbar")
	        .sort(function(d) { return x0(d.Job); });

	    var transition = chart.transition().duration(750),
	        delay = function(d, i) { return i * 50; };

	    transition.selectAll(".gbar")
	        .delay(delay)
		    .attr("transform", function(d, i) { return "translate(" + x0(d.Job) + ",0)"; });

	};

});

function type(d){
	if (d.Level == "NA") {
		d.Level = 0
	} else {
		d.Level = +d.Level
	}
	return d;
}
</script>
</body>
</html>